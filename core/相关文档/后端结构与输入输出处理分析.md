# 12306 后端结构与输入输出处理分析

## 概览
- 路由入口与挂载：`backend/src/app.js:28-33` 将模块挂载至 `/api/auth`, `/api/trains`, `/api/orders`, `/api/payments`, `/api/passengers`
- 数据库初始化：`backend/src/database/init.js:19-293` 启动即建表与种子数据；测试环境使用内存库 `:memory:`
- 健康检查：`backend/src/app.js:35-42` 返回 `{status:'ok', timestamp, message}`
- 统一 404：`backend/src/app.js:44-51` 未匹配路径返回 `{error, path, method}`
- 统一 500：`backend/src/app.js:53-60` 未捕获异常返回 `{error:'服务器内部错误', message}`（生产隐藏细节）

## 认证与授权
- JWT 生成：`backend/src/routes/auth.js:15-17` 载荷 `{userId}`，默认 24h 过期
- 授权校验（订单）：`backend/src/routes/orders.js:45-66` 检查 `Authorization: Bearer <token>`，非法或缺失 `401`
- 授权校验（支付）：`backend/src/routes/payments.js:18-34` 同上
- 授权校验（乘车人）：`backend/src/routes/passengers.js:6-16` 同上
- 当前用户信息：`backend/src/routes/auth.js:373-396` 从 `Authorization` 解 JWT，未授权 `401`，用户不存在 `404`

## 模块与接口

### /api/auth
- 发送验证码 `POST /send-code`（`backend/src/routes/auth.js:36-96`）
  - 正常：手机号格式正确、频率限制通过，返回 `{success:true, data:{codeId,(非生产包含code)}}`
  - 异常：手机号缺失或格式错 `400`；1分钟内重复发送 `429`；存储错误 `500`
- 注册 `POST /register`（`backend/src/routes/auth.js:98-195`）
  - 正常：用户名/邮箱/手机号/身份证唯一，验证码有效，返回 `201` 与 `token`
  - 异常：参数缺失 `400`；格式或唯一性校验失败 `400`；验证码无效/过期 `400`；数据库错误 `500`
- 登录 `POST /login`（`backend/src/routes/auth.js:197-250`）
  - 正常：识别器可为手机号/邮箱/用户名，密码匹配返回 `token` 与档案
  - 异常：参数缺失 `400`；用户不存在 `404`；密码错误 `401`；尝试过多 `429`；内部错误 `500`
- 忘记密码发送验证码 `POST /forgot/send-code`（`backend/src/routes/auth.js:252-287`）
  - 正常：账号（手机/邮箱）与身份证匹配，返回 `{codeId,(非生产code)}`
  - 异常：参数缺失/格式错 `400`；用户不存在 `404`；内部错误 `500`
- 忘记密码重置 `POST /forgot/reset`（`backend/src/routes/auth.js:289-320`）
  - 正常：验证码通过，更新密码返回成功
  - 异常：参数缺失/格式错 `400`；用户不存在 `404`；验证码错误/过期 `400`；内部错误 `500`
- 修改密码 `POST /change-password`（`backend/src/routes/auth.js:398-419`）
  - 正常：旧密码匹配，新密码 6-20 位，更新成功
  - 异常：未授权 `401`；参数缺失 `400`；新密码长度非法 `400`；用户不存在 `404`；旧密码不正确 `400`；内部错误 `500`
- 当前用户 `GET /me`（`backend/src/routes/auth.js:373-396`）
  - 正常：返回用户基本信息与创建/最后登录时间
  - 异常：未授权 `401`；用户不存在 `404`；内部错误 `500`
- 调试/测试：`GET /debug/users`（`backend/src/routes/auth.js:322-341`），`POST /clear-test-data` 仅测试环境（`backend/src/routes/auth.js:344-369`）

### /api/passengers
- 列表 `GET /`（`backend/src/routes/passengers.js:20-28`）
  - 正常：分页返回 `{passengers,total}`
  - 异常：未授权 `401`；数据库错误 `500`
- 新增 `POST /`（`backend/src/routes/passengers.js:30-39`）
  - 正常：姓名/证件/手机号齐备且身份证格式正确，返回 `201` 与 `id`
  - 异常：未授权 `401`；参数缺失 `400`；身份证格式错误 `400`；数据库错误 `500`
- 更新 `PUT /:id`（`backend/src/routes/passengers.js:41-52`）
  - 正常：字段校验通过且记录存在
  - 异常：未授权 `401`；参数缺失 `400`；身份证格式错误 `400`；记录不存在 `404`；数据库错误 `500`
- 删除 `DELETE /:id`（`backend/src/routes/passengers.js:54-61`）
  - 正常：删除成功
  - 异常：未授权 `401`；记录不存在 `404`；数据库错误 `500`
- 设默认 `POST /:id/default`（`backend/src/routes/passengers.js:63-70`）
  - 正常：清除用户默认后设定指定记录为默认
  - 异常：未授权 `401`；记录不存在 `404`；数据库错误 `500`

### /api/trains
- 搜索 `GET /search`（`backend/src/routes/trains.js:307-452`）
  - 正常：校验必填 `from/to/date` 与日期格式/非过去日；支持类型前缀、时间段筛选、三种排序与分页；返回 `seatTypes`（含价格）与分页
  - 异常：缺少必填 `400`；日期格式错误 `400`；过去日期 `400`
  - 兜底：数据库查询失败时使用 `mockTrains`（`backend/src/routes/trains.js:352-377`）

### /api/orders
- 创建 `POST /`（`backend/src/routes/orders.js:78-203`）
  - 正常：参数完整，乘客校验通过，库存充足；扣减库存并创建订单与乘客，返回 `201` `{orderId,status,totalAmount,paymentDeadline}`
  - 异常：未授权 `401`；订单信息/乘客信息不完整 `400`；身份证格式错 `400`；余票不足 `400`；数据库错误 `500`
- 查询 `GET /:orderId`（`backend/src/routes/orders.js:205-242`）
  - 正常：订单存在且归属同用户，返回详情与 `ticketInfo`（已支付时）
  - 异常：未授权 `401`；订单不存在 `404`；非本人访问 `403`；数据库错误 `500`
- 取消 `POST /:orderId/cancel`（`backend/src/routes/orders.js:244-285`）
  - 正常：仅 `PENDING_PAYMENT` 可取消，恢复库存、更新状态为 `CANCELLED`
  - 异常：未授权 `401`；订单不存在 `404`；非本人 `403`；状态不允许取消 `400`；数据库错误 `500`
- 退票 `POST /:orderId/refund`（`backend/src/routes/orders.js:315-356`）
  - 正常：仅 `PAID` 可退票，恢复库存并标记为 `CANCELLED`
  - 异常：未授权 `401`；订单不存在 `404`；非本人 `403`；状态不允许退票 `400`；数据库错误 `500`

### /api/payments
- 发起支付 `POST /initiate`（`backend/src/routes/payments.js:53-202`）
  - 正常：参数齐备，支付方式合法（`alipay/wechat/bankcard`）；订单存在且归属同用户，状态 `PENDING_PAYMENT` 且未过期；创建支付记录并返回 `paymentId` 与链接/二维码
  - 异常：未授权 `401`；参数缺失或不支持的支付方式 `400`；订单不存在 `404`；状态不允许或已过期 `400`
- 支付回调 `POST /callback`（`backend/src/routes/payments.js:204-290`）
  - 正常：参数与签名有效，更新支付为 `SUCCESS`，订单改为 `PAID` 并生成 `ticketInfo`，尝试持久化到数据库（失败仅日志）
  - 异常：参数缺失 `400`；签名错误（除测试签名 `mock_signature`）`400`；记录/订单不匹配/金额不匹配 `400`；重复回调 `200`（幂等）

## 模型与数据库
- 用户模型：`backend/src/models/User.js`
  - 创建用户（含 `email` 可空）、按 `phone/user_id/id_number/email` 查询、更新密码与最后登录、列出用户
  - 验证码模型：保存、按接收者失效、校验并标记使用、清理过期
- 订单模型：`backend/src/models/Order.js`
  - 创建订单与乘客、按 `orderId` 聚合查询、用户订单分页（联表 `trains`）、更新状态、设置 `PAID` 与 `ticket_info`
- 乘客模型：`backend/src/models/Passenger.js`
  - 列表分页、创建/更新/删除、设默认（清空后再设）
- 建表与种子：`backend/src/database/init.js`
  - 用户表唯一索引（`id_number`、`email`）与可选列 `email/last_login`；全量建表与列车种子/追加逻辑
  - 测试环境用内存库，避免数据污染

## 异常分类规范
- 参数校验：`400`（如“缺少必需参数”“身份证号格式不正确”“日期格式不正确”）
- 身份/授权：`401` 未授权；`403` 非本人资源访问
- 资源不存在：`404`（用户/订单）
- 频率限制：`429`（验证码发送、登录尝试）
- 业务状态限制：`400`（订单状态不允许取消/支付/退票、余票不足）
- 服务器错误：`500`（数据库或未预期异常）

## 兜底策略
- 列车查询兜底：数据库错误时回退到内置 `mockTrains`（`backend/src/routes/trains.js:352-377`）
- 库存初始化兜底：列车库查询失败则跳过 DB 填充，沿用内存库存（`backend/src/routes/orders.js:11-39`）

## 测试用例建议
- 认证与账号：注册（格式/唯一性/验证码有效与过期/测试验证码 `123456`）、登录（手机号/邮箱/用户名，错误密码，不存在用户，过多尝试）、修改密码（未授权、旧密码不匹配、新密码长度非法、成功）、忘记密码（发送与重置）、当前用户（无/坏/好 token，用户不存在）
- 乘车人：列表分页（空/非空、边界）、新增/更新（参数缺失、身份证格式错误、成功）、删除与设默认（存在/不存在）
- 列车查询：必填缺失、日期格式错误、过去日期、正常查询；类型前缀、时间段、三种排序；分页总数与页边界；数据库失败回退到 `mockTrains`
- 订单：创建（未授权、参数/乘客校验、身份证格式、库存不足、成功）、查询（未授权、非本人、不存在、成功含 `ticketInfo`）、取消（状态限制与库存恢复）、退票（仅 `PAID`，库存恢复）
- 支付：发起（未授权、方式非法、状态不允许/过期、成功返回支付数据）、回调（参数缺失、签名错误、记录/订单不匹配/金额不匹配、重复回调幂等、成功生成电子票并持久化）
- 全局：`/health` 正常返回；随机未定义路径返回 404；模拟抛错路径触发 500 中间件

